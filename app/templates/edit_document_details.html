{% extends "edit_entity.html" %}
{% block edit_form %}
  <form method="post">
    {{ render_field(entity_form.title_proper) }}
    {{ render_field(entity_form.parallel_title) }}
    {{ render_field(entity_form.other_title_inf) }}
    {{ render_form_row([entity_form.edition_statement,
    entity_form.parallel_edition_stmt, entity_form.additional_edition_stmt]) }}
    {{ render_form_row([entity_form.numbering, entity_form.publication_date,
    entity_form.pagination]) }}
    {{ render_form_row([entity_form.physical_details, entity_form.dimensions,
    entity_form.accompanying_material]) }}
    {{ render_field(entity_form.series) }}
    {{ render_field(entity_form.note) }}
    {{ render_form_row([entity_form.issn, entity_form.isbn_10,
    entity_form.isbn_13]) }}
    {{ render_field(entity_form.document_type) }}


    <!--responsibilities - collective bodies -->
    <!-- tworzone w pętli -->
    <div class="border border-light bg-light rounded pr-2 pl-2 m-1">
    {{ render_field(entity_form.responsibility_collectivities) }}
    <button id="remove-sel-collective-body-bt" class="btn btn-warning"> 
      Remove&nbsp;selected
    </button>
    <div class="row align-items-end pb-3">
      <div class="col">
	<div class="form-group">
	  <label class="form-control-label" for="select-ordering">Ordering:</label>
	  <select class="form-control" id="select-ordering" name="select-ordering">
	    {% for n in range(options['ordering_range']) %}
	      <option value="{{ n }}">{{ n }}</option>
	    {% endfor %}
	  </select>
	</div>
      </div>
      <div class="col mt-3">
	Selected collective body:
	<strong>
	  <p class="border border-dark rounded p-1" id="selected_collective_body">
	    &nbsp;
	  </p>
	</strong>
      </div>
      <div class="col">
	{{ render_field(entity_form.responsibility_names) }}
      </div>
      <div class="col">
	<button id="add-responsibility-coll-body" class="btn btn-secondary mb-3">Add</button>
      </div>
    </div><!-- row -->
    <!--<label class="form-control-label" for="collective-body-responsibility-stmt">Search for a collective body:</label>-->
    <input id="collective-body-responsibility-stmt" class="w-100 mb-3" placeholder="Type to search and add">
    <div id="resp-collectivities-list"></div>
    </div> <!-- border -->

    <!--responsibilities - people-individuals -->
    <div class="border border-light bg-light rounded pr-2 pl-2 m-1">
      {{ render_field(entity_form.responsibilities_people) }}
    <button id="remove-selected-individual-bt" class="btn btn-warning">
      Remove&nbsp;selected
    </button>
    <div class="row align-items-end pb-3">
      <div class="col">
	<div class="form-group">
	  <label class="form-control-label" for="select-ordering-individuals">Ordering:</label>
	  <select class="form-control" id="select-ordering-individuals" name="select-ordering-individuals">
	    {% for n in range(options['ordering_range']) %}
	      <option value="{{ n }}">{{ n }}</option>
	    {% endfor %}
	  </select>
	</div>
      </div>
      <div class="col mt-3">
	Selected individual:
	<strong>
	  <p class="border border-dark rounded p-1" id="selected_individual">
	    &nbsp;
	  </p>
	</strong>
      </div>
      <div class="col">
	
	{{ render_field(entity_form.responsibility_names,
	id="responsibility-names-individuals") }}
      </div>
      <div class="col">
	<button id="add-responsibility-individual" class="btn btn-secondary mb-3">Add</button>
      </div>
    </div><!-- row -->
    <input id="individual-responsibility-stmt" class="w-100 mb-3" placeholder="Type in to search, click item from a list to add.">
    <div id="resp-individuals-list"></div>
    </div> <!-- border -->

    <!-- languages -->
    <div class="row">
      <div class="col">
	<!-- Document language: -->
	<div class="row align-items-end">
	  <div class="col">
	    {{ render_field(entity_form.language_id) }}
	    {{ render_field(entity_form.language) }}
	  </div>
	  <div class="col">
	    <button id="clear-document-language" class="btn btn-danger mb-3">
	      Clear
	    </button>
	  </div>
	</div><!-- row -->
	<input id="document-language-input" class="w-100 mb-3" placeholder="Type in to search, click item from a list to select.">
	<div id="document-language-dropdown"></div>
      </div>
      <div class="col">
	<!-- Original language: -->
	<div class="row align-items-end">
	  <div class="col">
	    {{ render_field(entity_form.original_language) }}
	    {{ render_field(entity_form.original_language_id) }}
	  </div>
	  <div class="col">
	    <button id="clear-original-language" class="btn btn-danger mb-3">
	      Clear
	    </button>
	  </div>
	  <input id="original-language-input" class="w-100 mb-3" placeholder="Type in to search, click item from a list to select.">
	  <div id="original-language-dropdown"></div>
	</div><!-- row -->
      </div>
    </div>

    {{ render_field(entity_form.submit) }}
  </form>
{% endblock %}
{% block scripts %}
{{ super() }}
    <script type="application/javascript">

var selected_coll_body_id = undefined;
var selected_individual_id = undefined;

var search_coll_body = get_search_function(
    /* search collective body in responsibility section
     * on a document edit page
     * argument: input-id:
     * search_coll_body("collective-body-responsibility-stmt")
     */
    "{{ url_for('main.get_collective_bodies') }}",
    success_fn=results => {
	print_items_clear(
	    results[0],
	    $("#resp-collectivities-list"),
	    "#selected_collective_body",
	    click_fn=event => {
		selected_coll_body_id = event.target.id;
		$("#selected_collective_body").html(event.target.textContent);
	    })
    });

const search_individual = get_search_function(
    "{{ url_for('main.get_person_entries') }}",
    success_fn=results => {
	print_items_clear(
	    results[0],
	    $("#resp-individuals-list"),
	    "#selected_individual",
	    click_fn=event => {
		selected_individual_id = event.target.id;
		$("#selected_individual").html(event.target.textContent);
	    }
	)
    }
);

const search_document_language = get_search_function(
    "{{ url_for('main.get_language_entries') }}",
    success_fn=results => {
	// te funkcje mogą zostać zgeneralizowane
	// wszystko co nie wymaga wartości renderowanych na serwerze
	// powinno być poza tym plikiem
	print_items_clear(
	    results[0],
	    $("#document-language-dropdown"),
	    "#selected-document-language",
	    click_fn=event => {
		$("#language").val(event.target.textContent);
		$("#language_id").val(event.target.id);
	    }
	)
    }
);

const search_original_language = get_search_function(
    "{{ url_for('main.get_language_entries') }}",
    success_fn=results => {
	print_items_clear(
	    results[0],
	    $("#original-language-dropdown"),
	    "#selected-original-language",
	    click_fn=event => {
		$("#original_language").val(event.target.textContent);
		$("#original_language_id").val(event.target.id);
	    }
	)
    }
);

$(document).ready(function() {
    let responsibility_multichoice_fields = ["responsibility_collectivities",
					     "responsibilities_people"];

    responsibility_multichoice_fields.forEach(field => unselect_all(field));
    $("#submit-document").click(
	// select all items from responsibility multiselect
	// on submit-click
	() => responsibility_multichoice_fields.forEach(
	    field => select_all_from_multiselect("#"+field)));

    search_coll_body("collective-body-responsibility-stmt");
    search_document_language("document-language-input");
    search_individual("individual-responsibility-stmt");
    search_original_language("original-language-input");

    $("#remove-sel-collective-body-bt").click(target => {
	target.preventDefault();
	remove_sel_from_multiselect("#responsibility_collectivities");
    });
    $("#remove-selected-individual-bt").click(target => {
	target.preventDefault();
	remove_sel_from_multiselect("#responsibilities_people");
    });
    // add collective body responsibility
    $("#add-responsibility-coll-body").click(
	get_add_responsibility_fn(
	    "selected_coll_body_id", "#select-ordering",
	    "#responsibility_names", "#selected_collective_body",
	    "#responsibility_collectivities"));
    // add individual responsibility
    $("#add-responsibility-individual").click(
	get_add_responsibility_fn(
	    "selected_individual_id", "#select-ordering-individuals",
	    "#responsibility-names-individuals", "#selected_individual",
	    "#responsibilities_people"));

    $("#clear-original-language").click(target => {
	target.preventDefault();
	$("#original_language").val("");
	$("#original_language_id").val("");
    });
    $("#clear-document-language").click(target => {
	target.preventDefault();
	$("#language").val("");
	$("#language_id").val("");
    });  
});
</script>
{% endblock %}
